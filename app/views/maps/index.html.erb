<% require 'json' %>

<h1>My Family Map</h1>

<div class="form">
<% if @place.nil? %>
  <%= form_tag "/maps", method: :post do  %>
  <%= label_tag "Location:" %>
  <%= text_field_tag :location %>
  <%= label_tag "#{current_user.first_name}" %>
  <%= text_field_tag :description %>
  <%= submit_tag "Add my location" %><br>
  <% end %>
<% else %>
  <%= form_tag "/maps/:id", method: :patch do  %>
  <%= label_tag "Location:" %>
  <%= text_field_tag :location, "Enter new location" %>
  <%= label_tag "#{current_user.first_name}" %>
  <%= text_field_tag :description, "is.." %>
  <%= submit_tag "Update my location" %><br>
<% end %>
<% end %>
</div>
  
  <div id="map"></div>
  <script>
    function initMap() {
      var nyc = {lat: 40.7128, lng: -74.0059};

      var places = []
      <% @places.each do |place|%>
        places.push(<%= place.to_json.html_safe %>);
      <% end %>
      console.log(places);

      map = new google.maps.Map(document.getElementById('map'), {
          center: nyc,
          zoom: 8
        });
        for(var i = 0; i < places.length; i++){
          createMarker(places[i]);
        }
        function createMarker(location){
          var infowindow = new google.maps.InfoWindow({
            content: location.description
          });
          var marker = new google.maps.Marker({
            position: {lat: location.latitude, lng: location.longitude},
            map: map,
            title: ""
          });
          marker.addListener('click', function() {
            infowindow.open(map, marker);
          });
        }
      }
    
  </script>
  <script async defer
  src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['API_KEY_GOOGLE_MAPS'] %>&callback=initMap">
  </script>
  
